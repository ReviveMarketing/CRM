<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEADS INTERNO - REVIVE CRM</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #F8FAFC; color: #1E293B; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 1);
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.05);
            border-radius: 24px;
        }

        .kanban-col {
            min-height: 500px;
            background: #F1F5F9;
            border-radius: 20px;
            border: 1px solid #E2E8F0;
        }

        .card-lead {
            background: white;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: grab;
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
            scroll-margin-top: 200px; /* Ajuste para o scroll parar com margem do topo */
        }
        .card-lead:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1); 
            border-color: #BFDBFE;
        }

        /* Efeito de destaque "Flash" (Luz/Piscada) */
        .highlight-card {
            animation: flash-focus 1.2s ease-in-out 2; /* Pisca 2 vezes rápido */
            z-index: 50 !important; /* Fica acima de tudo */
            position: relative;
            border-color: #3B82F6 !important;
        }

        @keyframes flash-focus {
            0%, 100% { 
                background-color: white; 
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
                transform: scale(1);
            }
            50% { 
                background-color: #DBEAFE; /* Fundo azulado claro */
                box-shadow: 0 0 40px 10px rgba(59, 130, 246, 0.6); /* Luz forte externa */
                transform: scale(1.05); /* Aumenta um pouco */
            }
        }

        .incomplete-lead {
            border: 2px solid #EF4444 !important;
            animation: pulse-red 2s infinite;
        }

        #mapContainer {
            width: 100%;
            height: 100%;
            z-index: 1; /* Z-Index ajustado */
            border-radius: 24px;
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 3px; }

        .btn-future {
            background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
            transition: all 0.3s;
        }
        .btn-future:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 10px 25px -5px rgba(37, 99, 235, 0.4); 
        }

        .chat-bubble {
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 0.85rem;
            position: relative;
            max-width: 90%;
        }
        .chat-coord { background-color: #EFF6FF; color: #1E40AF; margin-right: auto; border-bottom-left-radius: 2px; }
        .chat-vendedor { background-color: #F0FDF4; color: #166534; margin-left: auto; text-align: right; border-bottom-right-radius: 2px; }
        
        .fullscreen-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #F8FAFC; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        
        .whatsapp-frame-placeholder {
            background-color: #f0f2f5;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            opacity: 0.8;
        }
    </style>
</head>
<body>

<div id="app" class="flex h-screen overflow-hidden text-slate-800">
    
    <!-- Tela de Login / Sala -->
    <div v-if="!salaAtual" class="fullscreen-overlay">
        <div class="glass-panel p-12 text-center max-w-md w-full shadow-2xl relative">
            <div class="w-20 h-20 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-3xl flex items-center justify-center text-white font-bold text-4xl mx-auto mb-6 shadow-xl shadow-blue-200">R</div>
            <h1 class="text-3xl font-extrabold text-slate-800 mb-2 tracking-tight">Revive CRM</h1>
            <p class="text-slate-500 mb-10 font-medium">Inteligência Comercial & Jurídica</p>
            
            <div class="text-left mb-6">
                <label class="text-xs font-bold text-slate-400 uppercase ml-1 tracking-widest">Acessar Sala</label>
                <div class="relative mt-2 group">
                    <i class="fa-solid fa-layer-group absolute left-4 top-3.5 text-slate-400 group-focus-within:text-blue-500 transition"></i>
                    <input v-model="salaInput" @keyup.enter="entrarSala" type="text" placeholder="NOME DA EQUIPE" class="w-full pl-12 p-3.5 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 focus:bg-white transition uppercase font-bold text-slate-700 tracking-wide">
                </div>
            </div>

            <button @click="entrarSala" :disabled="!salaInput" class="w-full btn-future text-white py-4 rounded-xl font-bold text-lg shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                Acessar Sistema <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div v-if="toast.show" class="fixed top-6 right-6 z-50 bg-slate-900 text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-4 transition-all duration-500 transform translate-y-0 border-l-4 border-blue-500">
        <i :class="toast.icon" class="text-blue-400 text-xl"></i>
        <span class="font-medium">{{ toast.message }}</span>
    </div>

    <aside v-if="salaAtual" class="w-72 bg-white border-r border-slate-200 flex flex-col z-20 shadow-xl">
        <div class="p-8 flex items-center gap-4">
            <div class="w-10 h-10 bg-gradient-to-tr from-blue-600 to-indigo-600 rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg">R</div>
            <div>
                <h1 class="font-bold text-base tracking-widest text-slate-800">REVIVE</h1>
                <p class="text-[10px] font-bold text-blue-600 uppercase tracking-widest">Jurídico</p>
            </div>
        </div>

        <div class="px-6 mb-6">
            <div class="p-4 rounded-2xl bg-slate-50 border border-slate-200">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Sala Conectada</span>
                    <button @click="sairSala" class="text-xs text-red-400 hover:text-red-600 transition" title="Sair"><i class="fa-solid fa-power-off"></i></button>
                </div>
                <div class="font-black text-slate-700 text-lg truncate flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    {{ salaAtual }}
                </div>
            </div>
        </div>

        <nav class="flex-1 px-4 space-y-2">
            <a @click="changeView('dashboard')" :class="{'bg-blue-50 text-blue-700 ring-1 ring-blue-100': view === 'dashboard'}" class="flex items-center gap-4 p-3.5 rounded-xl cursor-pointer hover:bg-slate-50 transition group">
                <i class="fa-solid fa-chart-pie w-5 transition group-hover:scale-110"></i> 
                <span class="font-semibold text-sm">Dashboard</span>
            </a>
            <a @click="changeView('pipeline')" :class="{'bg-blue-50 text-blue-700 ring-1 ring-blue-100': view === 'pipeline'}" class="flex items-center gap-4 p-3.5 rounded-xl cursor-pointer hover:bg-slate-50 transition group">
                <i class="fa-solid fa-trello w-5 transition group-hover:scale-110"></i> 
                <span class="font-semibold text-sm">Pipeline</span>
            </a>
            <a @click="changeView('mapa')" :class="{'bg-blue-50 text-blue-700 ring-1 ring-blue-100': view === 'mapa'}" class="flex items-center gap-4 p-3.5 rounded-xl cursor-pointer hover:bg-slate-50 transition group">
                <i class="fa-solid fa-map-location-dot w-5 transition group-hover:scale-110"></i> 
                <span class="font-semibold text-sm">Geolocalização</span>
            </a>

            <!-- Menu: Conexões (WhatsApp) -->
            <a @click="changeView('conexoes')" :class="{'bg-blue-50 text-blue-700 ring-1 ring-blue-100': view === 'conexoes'}" class="flex items-center gap-4 p-3.5 rounded-xl cursor-pointer hover:bg-slate-50 transition group">
                <i class="fa-brands fa-whatsapp w-5 transition group-hover:scale-110 text-lg"></i> 
                <span class="font-semibold text-sm">Conexões</span>
            </a>

            <!-- NOVO: Menu Relatórios -->
            <a @click="changeView('relatorios')" :class="{'bg-blue-50 text-blue-700 ring-1 ring-blue-100': view === 'relatorios'}" class="flex items-center gap-4 p-3.5 rounded-xl cursor-pointer hover:bg-slate-50 transition group">
                <i class="fa-solid fa-file-export w-5 transition group-hover:scale-110"></i> 
                <span class="font-semibold text-sm">Relatórios</span>
            </a>
            
            <!-- Notificações -->
            <div class="relative">
                <a @click="showNotifications = !showNotifications" :class="{'bg-blue-50 text-blue-700': showNotifications}" class="flex items-center gap-4 p-3.5 rounded-xl cursor-pointer hover:bg-slate-50 transition group justify-between">
                    <div class="flex items-center gap-4">
                        <i class="fa-solid fa-bell w-5 transition group-hover:scale-110" :class="{'animate-swing text-red-500': unreadNotifications.length > 0}"></i> 
                        <span class="font-semibold text-sm">Alertas</span>
                    </div>
                    <span v-if="unreadNotifications.length > 0" class="bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-lg shadow-red-200">
                        {{ unreadNotifications.length }}
                    </span>
                </a>
                
                <!-- Dropdown COM SCROLL (ALTERADO) -->
                <div v-if="showNotifications" class="absolute left-0 top-full mt-2 w-full bg-white rounded-xl shadow-2xl border border-slate-100 overflow-hidden z-50 p-2 space-y-1 max-h-72 overflow-y-auto custom-scrollbar">
                    <div v-if="unreadNotifications.length === 0" class="text-center text-slate-400 py-4 text-xs">
                        Tudo limpo por aqui!
                    </div>
                    <div v-for="notif in unreadNotifications" :key="notif.id" @click="openNotification(notif)" class="p-3 hover:bg-blue-50 rounded-lg cursor-pointer transition border-b border-slate-50 last:border-0">
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-bold text-xs text-blue-600 truncate w-2/3">{{ notif.nome || 'Lead sem nome' }}</span>
                            <span class="text-[10px] text-yellow-600 bg-yellow-100 px-1 rounded">Coord</span>
                        </div>
                        <p class="text-xs text-slate-500 line-clamp-2 italic">Nova mensagem pendente...</p>
                    </div>
                </div>
            </div>

            <a @click="changeView('config')" :class="{'bg-blue-50 text-blue-700 ring-1 ring-blue-100': view === 'config'}" class="flex items-center gap-4 p-3.5 rounded-xl cursor-pointer hover:bg-slate-50 transition group mt-auto">
                <i class="fa-solid fa-users-gear w-5 transition group-hover:scale-110"></i> 
                <span class="font-semibold text-sm">Equipe</span>
            </a>
        </nav>
    </aside>

    <main v-if="salaAtual" class="flex-1 flex flex-col relative overflow-hidden bg-slate-50/50">
        
        <header class="h-20 bg-white/80 backdrop-blur-md border-b border-slate-200 flex items-center justify-between px-10 z-10 sticky top-0">
            <div>
                <h2 class="text-2xl font-bold text-slate-800">{{ pageTitle }}</h2>
                <div class="flex items-center gap-2 mt-0.5">
                    <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                    <p class="text-xs text-slate-400 font-medium">Sistema Operacional</p>
                </div>
            </div>
            
            <div class="flex items-center gap-6">
                <!-- Filtros Data -->
                <div v-if="view === 'dashboard'" class="hidden md:flex items-center gap-2 bg-white p-1.5 rounded-lg border border-slate-200 shadow-sm">
                    <div class="flex items-center px-3 gap-2 border-r border-slate-100">
                        <span class="text-[10px] font-bold text-slate-400 uppercase">Início</span>
                        <input type="date" v-model="filterStartDate" class="text-xs font-bold text-slate-600 bg-transparent outline-none cursor-pointer">
                    </div>
                    <div class="flex items-center px-3 gap-2">
                        <span class="text-[10px] font-bold text-slate-400 uppercase">Fim</span>
                        <input type="date" v-model="filterEndDate" class="text-xs font-bold text-slate-600 bg-transparent outline-none cursor-pointer">
                    </div>
                    <button v-if="filterStartDate || filterEndDate" @click="clearDates" class="px-2 text-slate-400 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
                </div>

                <!-- Busca com sugestões -->
                <div class="flex items-center shadow-sm rounded-full">
                    <div class="relative group">
                        <i class="fa-solid fa-magnifying-glass absolute left-4 top-3.5 text-slate-400 group-focus-within:text-blue-500 transition"></i>
                        <input 
                            v-model="searchInput" 
                            @keyup.enter="executeSearch" 
                            @input="showSuggestions = true"
                            type="text" 
                            placeholder="Buscar por Nome ou Contato..." 
                            class="pl-10 pr-4 py-3 bg-slate-100 hover:bg-white focus:bg-white border-y border-l border-slate-200 focus:border-blue-300 rounded-l-full text-sm focus:outline-none focus:ring-0 w-64 transition-all"
                        >
                        <!-- AUTOCOMPLETE DROPDOWN -->
                        <div v-if="showSuggestions && searchSuggestions.length > 0" class="absolute top-full left-0 w-[120%] bg-white border border-slate-200 rounded-xl shadow-2xl mt-2 z-50 overflow-hidden max-h-72 overflow-y-auto">
                            <div class="bg-slate-50 px-4 py-2 text-[10px] font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100">Sugestões Encontradas</div>
                            <div 
                                v-for="lead in searchSuggestions" 
                                :key="lead.id" 
                                @click="selectSuggestion(lead)"
                                class="p-3 hover:bg-blue-50 cursor-pointer border-b border-slate-50 last:border-0 flex justify-between items-center transition group/item"
                            >
                                <div>
                                    <p class="font-bold text-slate-700 text-sm group-hover/item:text-blue-600">{{ lead.nome }}</p>
                                    <p class="text-xs text-slate-400 flex items-center gap-1"><i class="fa-brands fa-whatsapp text-green-500"></i> {{ lead.telefone }}</p>
                                </div>
                                <span class="text-[9px] font-bold px-2 py-0.5 rounded bg-slate-100 text-slate-500 uppercase group-hover/item:bg-white group-hover/item:shadow-sm">{{ lead.etapa }}</span>
                            </div>
                        </div>
                    </div>
                    <button @click="executeSearch" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-r-full text-sm font-bold border border-blue-600 shadow-md transition hover:shadow-lg flex items-center gap-2">
                        <i class="fa-solid fa-filter"></i> Carregar
                    </button>
                </div>
                <button @click="openModal()" class="btn-future text-white px-6 py-2.5 rounded-full text-sm font-bold flex items-center gap-2 shadow-lg shadow-blue-200 hover:shadow-blue-300">
                    <i class="fa-solid fa-plus"></i> Novo Lead
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-auto p-8 relative flex flex-col scroll-smooth">

            <!-- DASHBOARD -->
            <div v-if="view === 'dashboard'" class="space-y-8 animate-fade-in">
                <!-- KPI Cards - Expandido para 5 colunas -->
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6">
                    <div class="glass-panel p-6 border-l-4 border-blue-500 relative overflow-hidden group">
                        <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest mb-1">Total Leads</p>
                        <h3 class="text-4xl font-extrabold text-slate-800">{{ filteredDashboardLeads.length }}</h3>
                    </div>
                    <div class="glass-panel p-6 border-l-4 border-yellow-500 relative overflow-hidden group">
                        <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest mb-1">Pipeline (Estimado)</p>
                        <h3 class="text-3xl font-extrabold text-slate-800">{{ formatMoeda(totalEstimado) }}</h3>
                    </div>
                    <div class="glass-panel p-6 border-l-4 border-green-500 relative overflow-hidden group">
                        <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest mb-1">Caixa (Realizado)</p>
                        <h3 class="text-3xl font-extrabold text-green-600">{{ formatMoeda(totalRealizado) }}</h3>
                    </div>
                    <div class="glass-panel p-6 border-l-4 border-purple-500 relative overflow-hidden group">
                        <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest mb-1">Ciclo Médio Vendas</p>
                        <h3 class="text-4xl font-extrabold text-slate-800">{{ cicloMedioVendas }} <span class="text-sm font-medium text-slate-400">dias</span></h3>
                    </div>
                    <div class="glass-panel p-6 border-l-4 border-indigo-500 relative overflow-hidden group">
                        <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest mb-1">Conversão Total</p>
                        <h3 class="text-4xl font-extrabold text-indigo-600">{{ taxaFechamento }}%</h3>
                        <div class="w-full bg-slate-100 h-1.5 rounded-full mt-3 overflow-hidden">
                            <div class="bg-indigo-500 h-1.5 rounded-full" :style="{width: taxaFechamento + '%'}"></div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Conversão por Origem -->
                    <div class="glass-panel p-8 col-span-1 lg:col-span-2">
                         <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-lg text-slate-800">Taxa de Conversão por Origem</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left border-collapse">
                                <thead class="text-xs text-slate-400 font-bold uppercase border-b border-slate-100">
                                    <tr>
                                        <th class="px-4 py-3">Origem</th>
                                        <th class="px-4 py-3">Total Leads</th>
                                        <th class="px-4 py-3">Fechados</th>
                                        <th class="px-4 py-3 text-right">Taxa Conv.</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-50">
                                    <tr v-for="origem in statsPorOrigem" :key="origem.nome" class="hover:bg-blue-50/50 transition duration-200">
                                        <td class="px-4 py-4 font-bold text-slate-700">{{ origem.nome }}</td>
                                        <td class="px-4 py-4 text-slate-600">{{ origem.total }}</td>
                                        <td class="px-4 py-4 text-green-600 font-bold">{{ origem.fechados }}</td>
                                        <td class="px-4 py-4 text-right">
                                            <span class="px-2 py-1 rounded-md text-xs font-bold" :class="origem.taxa > 20 ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-600'">{{ origem.taxa }}%</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="glass-panel p-8 flex flex-col">
                        <h3 class="font-bold text-lg mb-6 w-full text-left text-slate-800">Distribuição (Origem)</h3>
                         <div class="relative w-full h-64">
                             <canvas id="chartOrigem"></canvas>
                         </div>
                    </div>
                </div>

                <div class="glass-panel p-8">
                    <h3 class="font-bold text-lg mb-6 text-slate-800">Funil de Etapas</h3>
                    <div class="h-72 w-full">
                        <canvas id="chartEtapas"></canvas>
                    </div>
                 </div>

                 <!-- Ranking de Consultores -->
                 <div class="glass-panel p-8 mt-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-lg text-slate-800">Ranking de Performance (Vendedores)</h3>
                        <span class="text-xs font-bold text-slate-400 bg-slate-100 px-3 py-1 rounded-full uppercase">Top Performers</span>
                    </div>
                    <div class="overflow-x-auto max-h-80 overflow-y-auto custom-scrollbar">
                        <table class="w-full text-sm text-left border-collapse">
                            <thead class="text-xs text-slate-400 font-bold uppercase border-b border-slate-100 sticky top-0 bg-white z-10">
                                <tr>
                                    <th class="px-6 py-3">Posição</th>
                                    <th class="px-6 py-3">Consultor</th>
                                    <th class="px-6 py-3 text-center">Leads Totais</th>
                                    <th class="px-6 py-3 text-center">Vendas (Fechados)</th>
                                    <th class="px-6 py-3 text-right">Conversão Individual</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-50">
                                <tr v-for="(c, i) in rankingConsultores" :key="c.nome" class="hover:bg-slate-50 transition duration-200">
                                    <td class="px-6 py-4">
                                        <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-white shadow-md" 
                                             :class="i === 0 ? 'bg-yellow-400 ring-2 ring-yellow-200' : (i === 1 ? 'bg-slate-400' : (i === 2 ? 'bg-orange-400' : 'bg-slate-200 text-slate-500'))">
                                            {{ i + 1 }}
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 font-bold text-slate-700 flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-100 to-indigo-100 text-blue-600 flex items-center justify-center font-bold text-xs uppercase border border-blue-200">
                                            {{ c.nome.charAt(0) }}
                                        </div>
                                        {{ c.nome }}
                                    </td>
                                    <td class="px-6 py-4 text-center text-slate-600 font-medium">{{ c.leads }}</td>
                                    <td class="px-6 py-4 text-center">
                                        <span class="px-3 py-1 rounded-full bg-green-100 text-green-700 font-bold">{{ c.fechados }}</span>
                                    </td>
                                    <td class="px-6 py-4 text-right">
                                        <div class="flex items-center justify-end gap-2">
                                            <span class="font-bold text-slate-700">{{ c.conversao }}%</span>
                                            <div class="w-16 h-1.5 bg-slate-200 rounded-full overflow-hidden">
                                                <div class="h-full bg-blue-500" :style="{width: c.conversao + '%'}"></div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                 </div>
            </div>

            <!-- MAPA RESTAURADO (TELA CHEIA) -->
            <div v-if="view === 'mapa'" class="flex-1 flex flex-col h-full relative animate-fade-in p-6">
                <div class="glass-panel w-full h-full p-0 overflow-hidden relative shadow-2xl border-0">
                     <div id="mapContainer" class="w-full h-full z-10"></div>
                     
                     <div class="absolute top-4 left-4 z-[500] bg-white/90 backdrop-blur px-4 py-3 rounded-xl shadow-lg border border-slate-200">
                        <h3 class="font-bold text-slate-700 text-sm"><i class="fa-solid fa-location-dot text-blue-500 mr-2"></i>Mapa de Calor</h3>
                        <p class="text-[10px] text-slate-500 mt-1">{{ leads.length }} leads mapeados</p>
                     </div>

                     <div v-if="loadingMap" class="absolute inset-0 flex items-center justify-center text-slate-500 bg-white/80 z-50">
                        <i class="fa-solid fa-satellite-dish fa-spin mr-2 text-blue-500"></i> Carregando satélite...
                    </div>
                </div>
            </div>

            <!-- PIPELINE -->
            <div v-if="view === 'pipeline'" class="flex flex-col h-full overflow-hidden">
                <!-- Filtros Avançados (Vendedor e Etapa) -->
                <div class="px-2 py-4 flex items-center gap-4 bg-slate-50/50 backdrop-blur rounded-xl mb-2">
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-bold text-slate-500"><i class="fa-solid fa-user-tie text-blue-500"></i> Vendedor:</label>
                        <div class="relative group">
                            <select v-model="pipelineFilterConsultant" class="appearance-none bg-white border border-slate-300 hover:border-blue-400 rounded-lg py-2 pl-3 pr-8 text-sm font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-100 cursor-pointer transition">
                                <option value="">Todos</option>
                                <option v-for="c in listaConsultores" :value="c">{{ c }}</option>
                            </select>
                            <i class="fa-solid fa-chevron-down absolute right-3 top-3 text-xs text-slate-400 pointer-events-none"></i>
                        </div>
                    </div>

                    <div class="flex items-center gap-2">
                        <label class="text-sm font-bold text-slate-500"><i class="fa-solid fa-filter text-indigo-500"></i> Etapa (Filtro):</label>
                        <div class="relative group">
                            <select v-model="pipelineFilterEtapa" class="appearance-none bg-white border border-slate-300 hover:border-indigo-400 rounded-lg py-2 pl-3 pr-8 text-sm font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-indigo-100 cursor-pointer transition">
                                <option value="">Todas as Etapas</option>
                                <option v-for="e in etapas" :value="e">{{ e }}</option>
                            </select>
                            <i class="fa-solid fa-chevron-down absolute right-3 top-3 text-xs text-slate-400 pointer-events-none"></i>
                        </div>
                    </div>
                </div>

                <div class="flex gap-6 h-full overflow-x-auto pb-4 px-2">
                    <!-- LOOP AGORA FILTRA COLUNAS -->
                    <div v-for="etapa in filteredEtapas" :key="etapa" class="min-w-[320px] w-[320px] flex flex-col transition-all duration-300">
                        <div class="flex justify-between items-center mb-4 px-1">
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full" :class="etapa === 'Recebido (Fechado)' ? 'bg-green-500' : 'bg-blue-500'"></span>
                                <h3 class="font-bold text-slate-700 uppercase text-xs tracking-wider">{{ etapa }}</h3>
                            </div>
                            <span class="bg-white border border-slate-200 text-slate-600 text-xs px-2.5 py-1 rounded-lg font-bold shadow-sm">{{ getLeadsByEtapa(etapa).length }}</span>
                        </div>
                        
                        <div class="kanban-col flex-1 p-3 space-y-4 overflow-y-auto custom-scrollbar" 
                            @drop="onDrop($event, etapa)" 
                            @dragover.prevent 
                            @dragenter.prevent>
                            
                            <!-- ADICIONADO ID PARA O CARD -->
                            <div v-for="lead in getLeadsByEtapa(etapa)" 
                                :key="lead.id" 
                                :id="'lead-' + lead.id"
                                draggable="true" 
                                @dragstart="startDrag($event, lead)"
                                @click="editLead(lead)"
                                class="card-lead p-5 rounded-2xl shadow-sm border border-slate-100 group"
                                :class="{'incomplete-lead': isIncomplete(lead)}">
                                
                                <div v-if="isIncomplete(lead)" title="Incompleto: Falta Nome" class="absolute -right-2 -top-2 bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs shadow-md z-10 font-bold">!</div>

                                <!-- Indicador de msg pendente -->
                                <div v-if="lead.msgAtiva" class="bg-red-50 text-red-600 text-[10px] p-2 rounded-lg mb-3 border border-red-100 flex items-center justify-between animate-pulse">
                                    <span class="font-bold flex items-center gap-1"><i class="fa-solid fa-comment-dots"></i> Nova mensagem</span>
                                    <span class="text-[9px]">Ver agora</span>
                                </div>

                                <div class="flex justify-between items-start mb-2">
                                    <span class="text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded-md uppercase tracking-wide">{{ lead.consultor || 'Livre' }}</span>
                                    <span class="text-[10px] text-slate-400 font-medium">{{ lead.origem || '?' }}</span>
                                </div>
                                
                                <h4 class="font-bold text-slate-800 text-base mb-1 leading-snug group-hover:text-blue-600 transition-colors" :class="{'text-red-500 italic': !lead.nome}">
                                    {{ lead.nome || 'Sem Nome' }}
                                </h4>
                                <p class="text-xs text-slate-500 mb-1">{{ lead.campanha || '' }}</p>
                                <!-- GARANTINDO O CONTATO VISÍVEL -->
                                <p class="text-xs text-slate-500 flex items-center gap-1 mb-3 font-medium bg-slate-50 p-1 rounded inline-block">
                                    <i class="fa-solid fa-phone text-[10px] text-slate-400"></i> {{ lead.telefone }}
                                </p>
                                
                                <!-- DATA e HORA adicionadas aqui no layout do footer -->
                                <div class="flex justify-between items-center border-t border-slate-100 pt-3">
                                    <div class="flex flex-col">
                                        <span v-if="lead.dataCriacao" class="text-[10px] font-medium text-slate-400 flex items-center gap-1 mb-1" title="Data/Hora Cadastro">
                                            <i class="fa-regular fa-clock"></i> {{ new Date(lead.dataCriacao).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }) }}
                                        </span>
                                        <span class="text-sm font-bold text-slate-700">{{ formatMoeda(lead.receitaEstimada) }}</span>
                                    </div>
                                    <a :href="'https://wa.me/55'+cleanPhone(lead.telefone)" target="_blank" @click.stop class="text-green-500 hover:text-white hover:bg-green-500 bg-green-50 p-2 rounded-full transition-all duration-300 transform hover:scale-110 shadow-sm">
                                        <i class="fa-brands fa-whatsapp text-lg"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TELA DE CONEXÕES MULTI-WHATSAPP -->
            <div v-if="view === 'conexoes'" class="w-full h-full flex flex-col animate-fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-8 h-full">
                    
                    <!-- Coluna da Esquerda: LISTA DE VENDEDORES -->
                    <div class="glass-panel p-6 col-span-1 flex flex-col">
                        <h3 class="text-xl font-bold text-slate-800 mb-1 flex items-center gap-2">
                            <i class="fa-brands fa-whatsapp text-green-500"></i> Hub de Atendimento
                        </h3>
                        <p class="text-xs text-slate-500 mb-6">Gerencie as instâncias de cada vendedor.</p>

                        <!-- Input Adicionar -->
                        <div class="flex gap-2 mb-6">
                            <input v-model="newSessionName" @keyup.enter="addNewSession" placeholder="Ex: Whats João..." class="flex-1 p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs outline-none focus:ring-2 focus:ring-green-400">
                            <button type="button" @click="addNewSession" class="bg-green-500 hover:bg-green-600 text-white px-3 rounded-xl shadow-md transition transform active:scale-95"><i class="fa-solid fa-plus"></i></button>
                        </div>

                        <div class="flex-1 overflow-y-auto custom-scrollbar space-y-2">
                            <div v-for="(session, index) in whatsappSessions" :key="index" 
                                @click="activeSessionIndex = index"
                                class="p-4 rounded-xl cursor-pointer border transition flex justify-between items-center group relative overflow-hidden"
                                :class="activeSessionIndex === index ? 'bg-green-50 border-green-500 shadow-sm' : 'bg-white border-slate-100 hover:border-green-300'">
                                
                                <div class="flex items-center gap-3 relative z-10">
                                    <div class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold text-xs"
                                         :class="activeSessionIndex === index ? 'bg-green-500' : 'bg-slate-300'">
                                         {{ session.nome.charAt(0).toUpperCase() }}
                                    </div>
                                    <div>
                                        <p class="font-bold text-sm" :class="activeSessionIndex === index ? 'text-green-800' : 'text-slate-700'">{{ session.nome }}</p>
                                        <p class="text-[10px] text-slate-400">Clique para acessar</p>
                                    </div>
                                </div>

                                <button type="button" @click.stop="removeSession(index)" class="text-slate-300 hover:text-red-500 relative z-10 p-2"><i class="fa-solid fa-trash text-xs"></i></button>
                            </div>
                            
                            <div v-if="whatsappSessions.length === 0" class="text-center py-10 text-slate-400 border-2 border-dashed border-slate-100 rounded-xl">
                                <p class="text-xs">Nenhum vendedor conectado.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Coluna da Direita: ÁREA DE NAVEGAÇÃO -->
                    <div class="glass-panel col-span-1 lg:col-span-3 flex flex-col overflow-hidden relative p-0 bg-slate-100">
                         <div v-if="activeSessionIndex !== null && whatsappSessions[activeSessionIndex]" class="flex flex-col h-full w-full">
                             <div class="h-12 bg-slate-200 border-b border-slate-300 flex items-center px-4 gap-4">
                                 <div class="flex gap-1.5">
                                     <div class="w-3 h-3 rounded-full bg-red-400"></div>
                                     <div class="w-3 h-3 rounded-full bg-yellow-400"></div>
                                     <div class="w-3 h-3 rounded-full bg-green-400"></div>
                                 </div>
                                 <div class="flex-1 bg-white h-8 rounded-md flex items-center px-3 text-xs text-slate-500 gap-2 mx-4 shadow-sm">
                                     <i class="fa-solid fa-lock text-[10px]"></i> web.whatsapp.com
                                 </div>
                                 <div class="text-xs font-bold text-slate-600">
                                     {{ whatsappSessions[activeSessionIndex].nome }}
                                 </div>
                             </div>

                             <div class="flex-1 relative whatsapp-frame-placeholder flex flex-col items-center justify-center text-center p-8">
                                 <div class="bg-white/90 backdrop-blur p-8 rounded-3xl shadow-2xl max-w-lg">
                                     <div class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-6 text-white text-4xl shadow-lg shadow-green-200">
                                         <i class="fa-brands fa-whatsapp"></i>
                                     </div>
                                     <h2 class="text-2xl font-bold text-slate-800 mb-2">Conectar ao WhatsApp Web</h2>
                                     <p class="text-slate-500 text-sm mb-6 leading-relaxed">
                                         Devido às políticas de segurança do navegador, o WhatsApp Web não pode ser aberto diretamente dentro desta janela (iframe).
                                     </p>
                                     <button @click="openExternalWhatsapp" class="w-full py-4 bg-slate-800 hover:bg-slate-900 text-white rounded-xl font-bold shadow-xl transition transform hover:-translate-y-1 flex items-center justify-center gap-3">
                                         <span>Abrir Painel Flutuante</span>
                                         <i class="fa-solid fa-external-link-alt"></i>
                                     </button>
                                     <p class="text-[10px] text-slate-400 mt-4">Ao clicar, uma nova janela abrirá para você escanear o QR Code deste vendedor.</p>
                                 </div>
                             </div>
                         </div>
                         <div v-else class="flex flex-col items-center justify-center h-full text-slate-400">
                             <i class="fa-brands fa-whatsapp text-6xl mb-4 text-slate-300"></i>
                             <h3 class="text-xl font-bold text-slate-500">Selecione um Vendedor</h3>
                             <p class="text-sm">Escolha uma instância no menu lateral para visualizar.</p>
                         </div>
                    </div>
                </div>
            </div>

            <!-- NOVA TELA: RELATÓRIOS E EXPORTAÇÃO -->
            <div v-if="view === 'relatorios'" class="max-w-4xl mx-auto w-full animate-fade-in">
                <div class="glass-panel p-10">
                    <div class="flex items-center gap-4 mb-8 border-b border-slate-100 pb-6">
                        <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center text-blue-600 text-2xl">
                            <i class="fa-solid fa-file-export"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-slate-800">Central de Exportação</h3>
                            <p class="text-slate-500">Gere relatórios detalhados ou resumos diários.</p>
                        </div>
                    </div>

                    <!-- Filtros de Exportação -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div>
                            <label class="block text-sm font-bold text-slate-500 mb-2">Data do Relatório</label>
                            <input type="date" v-model="exportData.date" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none font-medium text-slate-700 focus:ring-2 focus:ring-blue-200">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-500 mb-2">Filtrar Consultor (Opcional)</label>
                            <select v-model="exportData.consultor" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl outline-none font-medium text-slate-700 focus:ring-2 focus:ring-blue-200">
                                <option value="">Todos os Consultores</option>
                                <option v-for="c in listaConsultores" :value="c">{{ c }}</option>
                            </select>
                        </div>
                    </div>

                    <!-- Botões de Ação -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Excel / CSV -->
                        <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200 hover:border-green-300 transition group">
                            <div class="flex items-center gap-3 mb-3">
                                <i class="fa-solid fa-file-csv text-green-500 text-2xl"></i>
                                <h4 class="font-bold text-slate-800">Planilha Completa</h4>
                            </div>
                            <p class="text-xs text-slate-500 mb-6">Exporta todos os dados filtrados para Excel/CSV (Nome, Número, Obs, Fratura).</p>
                            <button @click="generateCSV" class="w-full py-3 bg-green-500 hover:bg-green-600 text-white rounded-xl font-bold shadow-lg shadow-green-100 transition transform group-hover:-translate-y-1">
                                <i class="fa-solid fa-download mr-2"></i> Baixar Planilha
                            </button>
                        </div>

                        <!-- Word / Resumo -->
                        <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200 hover:border-blue-300 transition group">
                            <div class="flex items-center gap-3 mb-3">
                                <i class="fa-solid fa-file-word text-blue-500 text-2xl"></i>
                                <h4 class="font-bold text-slate-800">Resumo Diário (Word)</h4>
                            </div>
                            <p class="text-xs text-slate-500 mb-6">Gera um documento formatado com o resumo dos atendimentos do dia.</p>
                            <button @click="generateWord" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg shadow-blue-100 transition transform group-hover:-translate-y-1">
                                <i class="fa-solid fa-file-lines mr-2"></i> Baixar Resumo DOC
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div v-if="view === 'config'" class="max-w-3xl mx-auto w-full">
                 <div class="glass-panel p-10">
                    <h3 class="text-2xl font-bold mb-2 text-slate-800">Gestão de Consultores</h3>
                    <p class="text-slate-500 mb-8">Adicione ou remova membros da equipe.</p>
                    
                    <div class="flex gap-3 mb-8 bg-slate-50 p-2 rounded-xl border border-slate-200 focus-within:ring-2 focus-within:ring-blue-100 transition">
                        <input v-model="novoConsultor" type="text" placeholder="Nome do novo consultor..." class="flex-1 p-3 bg-transparent outline-none text-slate-700 font-medium">
                        <button @click="addConsultor" class="bg-blue-600 hover:bg-blue-700 text-white px-6 rounded-lg font-bold transition shadow-lg shadow-blue-200">Adicionar</button>
                    </div>

                    <ul class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <li v-for="(nome, index) in listaConsultores" :key="index" class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-slate-100 hover:border-blue-200 hover:shadow-md transition">
                            <span class="font-medium text-slate-700">{{ nome }}</span>
                            <button @click="removeConsultor(index)" class="w-8 h-8 rounded-full flex items-center justify-center text-slate-300 hover:text-red-500 hover:bg-red-50 transition"><i class="fa-solid fa-trash"></i></button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </main>

    <!-- MODAL LEAD -->
    <div v-if="showModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 transition-opacity">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col overflow-hidden animate-scale-up">
            
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <div>
                    <h3 class="text-2xl font-bold text-slate-800">{{ editingLead ? 'Editar Cliente' : 'Novo Lead' }}</h3>
                </div>
                <button @click="closeModal" class="w-10 h-10 rounded-full bg-white hover:bg-red-50 text-slate-400 hover:text-red-500 transition shadow-sm flex items-center justify-center text-lg"><i class="fa-solid fa-times"></i></button>
            </div>

            <div class="p-8 overflow-y-auto flex-1">
                <!-- GRID PRINCIPAL (DADOS & GESTÃO) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-10 mb-8">
                    <!-- Coluna 1: Dados Pessoais & Origem -->
                    <div class="space-y-6">
                        <h4 class="font-bold text-blue-600 text-sm uppercase tracking-widest border-b border-blue-100 pb-2 mb-2 flex items-center gap-2"><i class="fa-regular fa-id-card"></i> Dados & Origem</h4>
                        
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase">Telefone <span class="text-red-500">*</span></label>
                            <input v-model="form.telefone" type="tel" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:border-blue-500 focus:bg-white outline-none transition font-medium text-slate-700" placeholder="(00) 00000-0000">
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase">Nome Completo</label>
                            <input v-model="form.nome" type="text" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:border-blue-500 focus:bg-white outline-none transition font-medium text-slate-700">
                        </div>

                        <div class="grid grid-cols-2 gap-5">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase">Origem</label>
                                <select v-model="form.origem" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none font-medium text-slate-700">
                                    <option value="Meta">Meta</option>
                                    <option value="Google">Google</option>
                                    <option value="TikTok">TikTok</option>
                                    <option value="Indicação">Indicação</option>
                                    <option value="Outros">Outros</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase">Campanha</label>
                                <input v-model="form.campanha" type="text" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none font-medium text-slate-700">
                            </div>
                        </div>

                        <!-- MODIFICADO: Dropdowns de Estado/Cidade -->
                        <div class="grid grid-cols-2 gap-5">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase">Estado (UF)</label>
                                <select v-model="form.estado" @change="carregarCidades(form.estado)" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none font-medium text-slate-700">
                                    <option value="">Selecione...</option>
                                    <option v-for="uf in estados" :key="uf.sigla" :value="uf.sigla">{{ uf.nome }}</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase">Cidade</label>
                                <select v-model="form.cidade" :disabled="!form.estado" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none font-medium text-slate-700 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <option value="">Selecione...</option>
                                    <option v-for="cidade in cidadesPorEstado" :key="cidade" :value="cidade">{{ cidade }}</option>
                                </select>
                            </div>
                        </div>

                         <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase">Benefício / Assunto</label>
                            <input v-model="form.beneficio" type="text" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none transition font-medium text-slate-700">
                        </div>

                        <!-- ADICIONADO: Campo Fratura -->
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase">Fratura</label>
                            <input v-model="form.fratura" type="text" placeholder="Ex: Fêmur, Tíbia, Punho..." class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none transition font-medium text-slate-700">
                        </div>
                    </div>

                    <!-- Coluna 2: Gestão, Valores & Observações (RESTAURADO) -->
                    <div class="space-y-6">
                        <h4 class="font-bold text-blue-600 text-sm uppercase tracking-widest border-b border-blue-100 pb-2 mb-2 flex items-center gap-2"><i class="fa-solid fa-chart-pie"></i> Gestão & Valores</h4>

                        <!-- NOVO: Seletor de Etapa no Modal -->
                        <div class="p-3 bg-indigo-50 border border-indigo-100 rounded-xl">
                            <label class="block text-xs font-bold text-indigo-800 mb-1.5 uppercase"><i class="fa-solid fa-trello mr-1"></i> Mover para Etapa do Pipeline</label>
                            <select v-model="form.etapa" class="w-full p-2 bg-white border border-indigo-200 rounded-lg outline-none font-bold text-indigo-700 cursor-pointer">
                                <option v-for="etapa in etapas" :value="etapa">{{ etapa }}</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-5">
                             <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase">Consultor Responsável</label>
                                <select v-model="form.consultor" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none font-medium text-slate-700">
                                    <option value="">Selecione...</option>
                                    <option v-for="nome in listaConsultores" :value="nome">{{ nome }}</option>
                                </select>
                            </div>
                            <div>
                                 <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase">Data Fechamento</label>
                                 <input v-model="form.dataFechamento" type="date" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-slate-700">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-5">
                            <div>
                                 <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase">Estimado (R$)</label>
                                 <input v-model="form.receitaEstimada" type="number" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-blue-600 font-bold text-lg outline-none">
                            </div>
                            <div>
                                 <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase">Realizado (R$)</label>
                                 <input v-model="form.receitaRealizada" type="number" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-green-600 font-bold text-lg outline-none" :disabled="form.etapa !== 'Recebido (Fechado)'">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1.5 uppercase">Observações Gerais</label>
                            <textarea v-model="form.obs" rows="4" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none resize-none text-slate-700" placeholder="Detalhes importantes sobre o lead..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- SESSÃO INFERIOR: CHAT (ACESSÍVEL VIA SCROLL) -->
                <div class="space-y-6 pt-6 border-t border-slate-200">
                     <h4 class="font-bold text-blue-600 text-sm uppercase tracking-widest flex items-center gap-2"><i class="fa-solid fa-comments"></i> Central de Mensagens & Histórico</h4>
                     
                     <!-- Chat Box Expandido -->
                    <div class="bg-slate-50 border border-slate-200 rounded-xl p-6 h-64 overflow-y-auto flex flex-col gap-3 custom-scrollbar shadow-inner">
                        <div v-if="!form.historicoMsg || form.historicoMsg.length === 0" class="flex flex-col items-center justify-center h-full text-slate-400">
                            <i class="fa-regular fa-comments text-3xl mb-2 opacity-30"></i>
                            <span class="text-xs">Nenhuma mensagem registrada. Inicie uma conversa abaixo.</span>
                        </div>
                        <div v-for="(msg, i) in form.historicoMsg" :key="i" class="chat-bubble" :class="msg.tipo === 'coord' ? 'chat-coord' : (msg.tipo === 'system' ? 'bg-slate-200 text-slate-500 text-center w-full mx-auto text-[10px] uppercase font-bold tracking-wider' : 'chat-vendedor')">
                            <p class="font-medium">{{ msg.texto }}</p>
                            <span v-if="msg.tipo !== 'system'" class="text-[9px] opacity-70 block mt-1">{{ new Date(msg.data).toLocaleString() }}</span>
                        </div>
                    </div>

                    <!-- Input Areas Lado a Lado -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="flex gap-2">
                             <input v-model="novaMsgCoord" placeholder="Enviar alerta como Coordenador..." class="flex-1 p-3 border border-yellow-200 bg-yellow-50 rounded-lg text-sm outline-none focus:ring-2 focus:ring-yellow-400 placeholder-yellow-700/50 text-yellow-900" @keyup.enter="enviarMsg('coord')">
                             <button @click="enviarMsg('coord')" class="bg-yellow-500 text-white px-4 rounded-lg hover:bg-yellow-600 shadow-md shadow-yellow-200"><i class="fa-solid fa-paper-plane"></i></button>
                        </div>
                        
                        <div class="flex gap-2">
                            <input v-model="novaMsgVendedor" placeholder="Responder como Vendedor..." class="flex-1 p-3 border border-green-200 bg-green-50 rounded-lg text-sm outline-none focus:ring-2 focus:ring-green-400 placeholder-green-700/50 text-green-900" @keyup.enter="enviarMsg('vendedor')">
                             <button @click="enviarMsg('vendedor')" class="bg-green-600 text-white px-4 rounded-lg hover:bg-green-700 shadow-md shadow-green-200"><i class="fa-solid fa-reply"></i></button>
                        </div>
                    </div>
                    
                    <button v-if="form.msgAtiva" @click="marcarComoLido" class="w-full py-3 bg-blue-50 border border-blue-100 text-blue-600 rounded-xl text-xs font-bold hover:bg-blue-100 transition shadow-sm">
                        <i class="fa-solid fa-check-double mr-1"></i> Marcar Alerta como Visualizado/Concluído
                    </button>
                </div>
            </div>

            <div class="p-6 border-t border-slate-100 bg-slate-50 flex justify-between items-center">
                <button v-if="editingLead" @click="deleteLead" class="text-red-500 font-bold hover:bg-red-50 px-6 py-3 rounded-xl transition flex items-center gap-2"><i class="fa-solid fa-trash"></i> Excluir</button>
                <div v-else></div>
                <button @click="saveLead" class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white px-10 py-3 rounded-xl font-bold shadow-lg shadow-blue-200 transition transform hover:-translate-y-1 flex items-center gap-2">
                    <i class="fa-solid fa-save"></i> Salvar Lead
                </button>
            </div>
        </div>
    </div>

</div>

<!-- Módulos Firebase e Aplicação -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Cache Estático de Capitais e Estados para carga instantânea
    const STATIC_COORDS = {
        "SP": [-23.5505, -46.6333], "SAO PAULO": [-23.5505, -46.6333],
        "RJ": [-22.9068, -43.1729], "RIO DE JANEIRO": [-22.9068, -43.1729],
        "MG": [-19.9167, -43.9345], "MINAS GERAIS": [-19.9167, -43.9345],
        "ES": [-20.3155, -40.3128], "ESPIRITO SANTO": [-20.3155, -40.3128],
        "RS": [-30.0346, -51.2177], "RIO GRANDE DO SUL": [-30.0346, -51.2177],
        "SC": [-27.5954, -48.5480], "SANTA CATARINA": [-27.5954, -48.5480],
        "PR": [-25.4284, -49.2733], "PARANA": [-25.4284, -49.2733],
        "BA": [-12.9777, -38.5016], "BAHIA": [-12.9777, -38.5016],
        "PE": [-8.0476, -34.8770], "PERNAMBUCO": [-8.0476, -34.8770],
        "CE": [-3.7172, -38.5434], "CEARA": [-3.7172, -38.5434],
        "DF": [-15.7975, -47.8919], "DISTRITO FEDERAL": [-15.7975, -47.8919],
        "GO": [-16.6869, -49.2648], "GOIAS": [-16.6869, -49.2648],
        "AM": [-3.1190, -60.0217], "AMAZONAS": [-3.1190, -60.0217],
        "MT": [-15.6014, -56.0979], "MATO GROSSO": [-15.6014, -56.0979],
        "MS": [-20.4697, -54.6201], "MATO GROSSO DO SUL": [-20.4697, -54.6201]
    };

    const USER_FIREBASE_CONFIG = {
        apiKey: "AIzaSyC0rXC6dYNhRzth6aa_5qcmavy0Q8wS0nA",
        authDomain: "crm-revive.firebaseapp.com",
        projectId: "crm-revive",
        storageBucket: "crm-revive.firebasestorage.app",
        messagingSenderId: "159299012557",
        appId: "1:159299012557:web:355a966f272c0191d8e684",
        measurementId: "G-LVVTP722EM"
    };

    let app, auth, db;
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                view: 'dashboard',
                salaInput: '',
                salaAtual: localStorage.getItem('revive_sala_atual') || '', 
                dbConnected: false,
                errorMessage: '',
                searchQuery: '',
                searchInput: '',
                showSuggestions: false, // Controle do dropdown
                filterStartDate: '',
                filterEndDate: '',
                showNotifications: false,
                loadingMap: false,
                
                showModal: false,
                editingLead: null,
                
                // VARIAVEIS MULTI-SESSION WHATSAPP
                whatsappSessions: [],
                newSessionName: '',
                activeSessionIndex: null,
                
                // Filtro Pipeline
                pipelineFilterConsultant: '',
                pipelineFilterEtapa: '', // NOVO

                // Dados de Exportação (NOVO)
                exportData: {
                    date: new Date().toISOString().split('T')[0],
                    consultor: ''
                },

                leads: [],
                allLeads: [],
                listaConsultores: ['João', 'Maria', 'Pedro'], 
                novoConsultor: '',
                etapas: ['Primeiro Contato', 'Cadastro', 'Negociação', 'Processo em Andamento', 'Aguardando Resultado', 'Recebido (Fechado)', 'Sem Resposta', 'Perdido/Sem Possibilidade'],
                
                form: {
                    id: null, nome: '', telefone: '', beneficio: '', condicao: '',
                    cidade: '', estado: '', obs: '', consultor: '', fratura: '',
                    origem: 'Meta', campanha: '',
                    receitaEstimada: 0, receitaRealizada: 0,
                    etapa: 'Primeiro Contato', 
                    historicoMsg: [], 
                    msgAtiva: false,
                    dataFechamento: ''
                },
                novaMsgCoord: '',
                novaMsgVendedor: '',

                estados: [],
                cidadesPorEstado: [],

                toast: { show: false, message: '', icon: '' },
                cityCache: {...STATIC_COORDS}
            }
        },
        created() {
            this.mapInstance = null;
            this.charts = {};
            this.carregarEstados();
        },
        mounted() {
            this.retryConnection();
            const saved = localStorage.getItem('revive_consultores');
            if(saved) this.listaConsultores = JSON.parse(saved);
            
            // Carregar Sessoes Salvas
            const savedSessions = localStorage.getItem('revive_whatsapp_sessions');
            if(savedSessions) this.whatsappSessions = JSON.parse(savedSessions);
        },
        computed: {
            pageTitle() {
                const titles = {
                    dashboard: 'Dashboard Executivo', 
                    pipeline: 'Pipeline de Vendas', 
                    mapa: 'Inteligência Geográfica', 
                    config: 'Configurações',
                    conexoes: 'Central de Conexões',
                    relatorios: 'Relatórios & Exportação'
                };
                return titles[this.view] || 'Revive CRM';
            },
            searchSuggestions() {
                if (!this.searchInput || this.searchInput.length < 2) return [];
                const term = this.searchInput.toLowerCase();
                return this.leads.filter(l => 
                    (l.nome && l.nome.toLowerCase().includes(term)) || 
                    (l.telefone && l.telefone.includes(term))
                ).slice(0, 5); // Limita a 5 sugestões
            },
            filteredLeads() {
                let result = this.leads;
                if (this.searchQuery) {
                    const term = this.searchQuery.toLowerCase();
                    result = result.filter(l => 
                        (l.nome && l.nome.toLowerCase().includes(term)) || 
                        (l.telefone && l.telefone.includes(term))
                    );
                }
                return result;
            },
            filteredEtapas() {
                if (this.pipelineFilterEtapa) {
                    return [this.pipelineFilterEtapa];
                }
                return this.etapas;
            },
            filteredDashboardLeads() {
                let result = this.leads;
                if (this.filterStartDate) {
                    result = result.filter(l => (l.dataCriacao || '').slice(0,10) >= this.filterStartDate);
                }
                if (this.filterEndDate) {
                    result = result.filter(l => (l.dataCriacao || '').slice(0,10) <= this.filterEndDate);
                }
                return result;
            },
            unreadNotifications() {
                return this.leads.filter(l => l.msgAtiva);
            },
            totalEstimado() { return this.filteredDashboardLeads.reduce((acc, l) => acc + (Number(l.receitaEstimada) || 0), 0); },
            totalRealizado() { 
                return this.filteredDashboardLeads.filter(l => l.etapa === 'Recebido (Fechado)').reduce((acc, l) => acc + (Number(l.receitaRealizada) || 0), 0); 
            },
            taxaFechamento() {
                const base = this.filteredDashboardLeads;
                const fechados = base.filter(l => l.etapa === 'Recebido (Fechado)').length;
                return base.length ? ((fechados / base.length) * 100).toFixed(1) : 0;
            },
            cicloMedioVendas() {
                const fechados = this.filteredDashboardLeads.filter(l => l.etapa === 'Recebido (Fechado)' && l.dataFechamento && l.dataCriacao);
                if (fechados.length === 0) return 0;
                
                const totalDias = fechados.reduce((acc, l) => {
                    const start = new Date(l.dataCriacao);
                    const end = new Date(l.dataFechamento);
                    const diffTime = Math.abs(end - start);
                    return acc + Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                }, 0);
                
                return (totalDias / fechados.length).toFixed(0);
            },
            statsPorOrigem() {
                const map = {};
                this.filteredDashboardLeads.forEach(l => {
                    const o = l.origem || 'Outros';
                    if(!map[o]) map[o] = { nome: o, total: 0, fechados: 0 };
                    map[o].total++;
                    if(l.etapa === 'Recebido (Fechado)') map[o].fechados++;
                });
                return Object.values(map).map(item => {
                    item.taxa = item.total ? ((item.fechados / item.total) * 100).toFixed(1) : 0;
                    return item;
                }).sort((a,b) => b.fechados - a.fechados);
            },
            rankingConsultores() {
                const ranking = {};
                this.listaConsultores.forEach(c => ranking[c] = { nome: c, leads: 0, fechados: 0, conversao: 0 });
                // Usa a lista filtrada por data para o ranking também
                this.filteredDashboardLeads.forEach(l => {
                    if (l.consultor && ranking[l.consultor]) {
                        ranking[l.consultor].leads++;
                        if (l.etapa === 'Recebido (Fechado)') ranking[l.consultor].fechados++;
                    }
                });
                return Object.values(ranking).map(r => {
                    r.conversao = r.leads ? ((r.fechados / r.leads) * 100).toFixed(0) : 0;
                    return r;
                }).sort((a, b) => b.fechados - a.fechados);
            },
            statsPorEstado() {
                const map = {};
                this.filteredDashboardLeads.forEach(l => {
                    const uf = l.estado || 'N/A';
                    if(!map[uf]) map[uf] = { estado: uf, total: 0, fechados: 0, andamento: 0 };
                    
                    map[uf].total++;
                    if(l.etapa === 'Recebido (Fechado)') {
                        map[uf].fechados++;
                    } else if (l.etapa !== 'Sem Resposta' && l.etapa !== 'Perdido/Sem Possibilidade' && l.etapa !== 'Sem Resposta / Perdido') {
                        map[uf].andamento++;
                    }
                });
                return Object.values(map).sort((a, b) => b.total - a.total);
            }
        },
        methods: {
            entrarSala() {
                if(!this.salaInput) return;
                this.salaAtual = this.salaInput.toUpperCase().trim();
                localStorage.setItem('revive_sala_atual', this.salaAtual);
                this.updateLeadsByRoom();
            },
            sairSala() {
                this.salaAtual = '';
                localStorage.removeItem('revive_sala_atual');
                this.leads = [];
                if(this.mapInstance) { this.mapInstance.remove(); this.mapInstance = null; }
            },
            showToast(msg, icon='fa-check-circle') {
                this.toast = { show: true, message: msg, icon: icon };
                setTimeout(() => this.toast.show = false, 3000);
            },
            clearDates() {
                this.filterStartDate = ''; this.filterEndDate = '';
                this.updateCharts();
            },
            executeSearch() {
                this.searchQuery = this.searchInput;
                this.showSuggestions = false;
                if(this.searchInput) {
                    this.showToast('Buscando...', 'fa-search');
                    // FIX: Força a navegação para o Pipeline para ver o resultado
                    this.view = 'pipeline'; 
                } else {
                    this.showToast('Filtro limpo', 'fa-rotate-left');
                }
            },
            async selectSuggestion(lead) {
                this.showSuggestions = false;
                this.searchInput = '';
                // FIX: Limpa o filtro de texto para garantir que o card do lead exista no DOM e possa ser rolado
                this.searchQuery = ''; 
                
                // 1. Mudar para view Pipeline
                this.view = 'pipeline';
                
                // 2. Esperar renderização
                await this.$nextTick();
                
                // 3. Rolar até o card e destacar (Com delay visual inteligente)
                setTimeout(() => {
                    const el = document.getElementById('lead-' + lead.id);
                    if(el) {
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        el.classList.add('highlight-card');
                        
                        // Remover classe de destaque após a animação (aprox 2.5s)
                        setTimeout(() => el.classList.remove('highlight-card'), 2500);
                        
                        // 4. Abrir modal com um pequeno delay para que o usuário veja o "piscar" primeiro
                        setTimeout(() => {
                             this.editLead(lead);
                        }, 800); 
                    } else {
                         // Fallback se o card não for encontrado (ex: filtro ativo)
                         this.editLead(lead);
                    }
                }, 500); 
            },
            openNotification(lead) {
                this.showNotifications = false;
                this.editLead(lead);
            },
            enviarMsg(tipo) {
                const texto = tipo === 'coord' ? this.novaMsgCoord : this.novaMsgVendedor;
                if(!texto) return;

                if(!this.form.historicoMsg) this.form.historicoMsg = [];
                
                this.form.historicoMsg.push({
                    tipo: tipo,
                    texto: texto,
                    data: new Date().toISOString()
                });

                if(tipo === 'coord') {
                    this.form.msgAtiva = true;
                    this.novaMsgCoord = '';
                } else {
                    this.novaMsgVendedor = '';
                }
            },
            marcarComoLido() {
                this.form.msgAtiva = false;
                if(!this.form.historicoMsg) this.form.historicoMsg = [];
                this.form.historicoMsg.push({
                    tipo: 'system',
                    texto: '--- Visualizado/Concluído pelo Vendedor ---',
                    data: new Date().toISOString()
                });
            },

            async carregarEstados() {
                try {
                    const res = await fetch('https://servicodados.ibge.gov.br/api/v1/localidades/estados?orderBy=nome');
                    const data = await res.json();
                    this.estados = data.map(uf => ({ sigla: uf.sigla, nome: uf.nome }));
                } catch(e) { console.error("Erro IBGE UF", e); }
            },
            async carregarCidades(uf) {
                if(!uf) { this.cidadesPorEstado = []; return; }
                try {
                    const res = await fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${uf}/municipios`);
                    const data = await res.json();
                    this.cidadesPorEstado = data.map(c => c.nome);
                } catch(e) { console.error("Erro IBGE Cidade", e); }
            },

            async retryConnection() {
                const config = USER_FIREBASE_CONFIG;
                try {
                    try { app = initializeApp(config); } catch(e) { } 
                    auth = getAuth(app);
                    db = getFirestore(app);
                    await signInAnonymously(auth);
                    onAuthStateChanged(auth, (user) => {
                        if (user) this.connectDB();
                    });
                } catch(e) { console.error(e); }
            },

            connectDB() {
                const leadsRef = collection(db, 'leads');
                onSnapshot(leadsRef, (snapshot) => {
                    this.dbConnected = true;
                    this.allLeads = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    this.updateLeadsByRoom();
                    if(this.view === 'dashboard') this.updateCharts();
                    if(this.view === 'mapa') setTimeout(() => this.initMap(), 500);
                });
            },

            updateLeadsByRoom() {
                if(this.salaAtual) this.leads = this.allLeads.filter(lead => lead.sala === this.salaAtual);
                else this.leads = [];
            },

            async changeView(newView) {
                this.view = newView;
                await this.$nextTick();
                if(newView === 'dashboard') this.updateCharts();
                if(newView === 'mapa') setTimeout(() => this.initMap(), 300); 
            },
            
            getLeadsByEtapa(etapa) { 
                return this.filteredLeads.filter(l => {
                    const matchEtapa = l.etapa === etapa;
                    // Filtro de Consultor do Pipeline
                    const matchConsultant = this.pipelineFilterConsultant ? l.consultor === this.pipelineFilterConsultant : true;
                    return matchEtapa && matchConsultant;
                });
            },
            isIncomplete(lead) { return lead.telefone && !lead.nome; },
            cleanPhone(phone) { return phone ? phone.replace(/\D/g,'') : ''; },
            formatMoeda(val) { return Number(val).toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'}); },
            
            async initMap() {
                const container = document.getElementById('mapContainer');
                if(!container) return;
                
                // Verificação de segurança se L (Leaflet) está carregado
                if (typeof L === 'undefined') {
                    console.error("Leaflet não carregado.");
                    return;
                }
                
                if (this.mapInstance) {
                    this.mapInstance.remove();
                    this.mapInstance = null;
                }
                
                this.mapInstance = L.map('mapContainer').setView([-14.2350, -51.9253], 4);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.mapInstance);
                
                this.loadingMap = true;

                const cityGroups = {};
                
                this.leads.forEach(lead => {
                    if(lead.cidade || lead.estado) {
                        const cidadeLimpa = lead.cidade ? lead.cidade.trim() : '';
                        const estadoLimpo = lead.estado ? lead.estado.trim().toUpperCase() : '';
                        
                        let key = cidadeLimpa ? `${cidadeLimpa}-${estadoLimpo}` : estadoLimpo;
                        let query = cidadeLimpa ? `${cidadeLimpa}, ${estadoLimpo}, Brasil` : `${estadoLimpo}, Brasil`;

                        if(!cityGroups[key]) cityGroups[key] = { leads: [], fullQuery: query };
                        cityGroups[key].leads.push(lead);
                    }
                });

                for (const [key, data] of Object.entries(cityGroups)) {
                    let coords = this.cityCache[key];
                    if (!coords) {
                        try {
                            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(data.fullQuery)}&limit=1`);
                            const apiData = await response.json();
                            if(apiData && apiData.length > 0) {
                                coords = [parseFloat(apiData[0].lat), parseFloat(apiData[0].lon)];
                                this.cityCache[key] = coords; 
                            }
                        } catch(e) { console.log('Erro geocoding', e); }
                    }

                    if (coords) {
                        data.leads.forEach(lead => {
                            let color = '#F97316'; 
                            if (lead.etapa === 'Recebido (Fechado)') color = '#22C55E';
                            else if (lead.etapa === 'Perdido/Sem Possibilidade') color = '#EF4444';
                            
                            const latJitter = coords[0] + (Math.random() - 0.5) * 0.008;
                            const lngJitter = coords[1] + (Math.random() - 0.5) * 0.008;

                            L.circleMarker([latJitter, lngJitter], { 
                                radius: 8, 
                                fillColor: color, 
                                color: '#fff', 
                                weight: 2, 
                                opacity: 1, 
                                fillOpacity: 0.9 
                            })
                             .addTo(this.mapInstance)
                             .bindPopup(`
                                <div class="text-center">
                                    <strong class="text-sm block mb-1">${lead.nome || 'Lead'}</strong>
                                    <span class="text-xs text-slate-500">${lead.cidade || ''}/${lead.estado || ''}</span><br>
                                    <span class="text-xs font-bold ${lead.etapa === 'Recebido (Fechado)' ? 'text-green-600' : (lead.etapa === 'Perdido/Sem Possibilidade' ? 'text-red-500' : 'text-orange-500')}">${lead.etapa}</span>
                                </div>
                             `);
                        });
                    }
                }
                this.loadingMap = false;
            },

            updateCharts() {
                const leadsData = this.filteredDashboardLeads;
                
                const ctxOrigem = document.getElementById('chartOrigem');
                if(ctxOrigem) {
                    if(this.charts.origem) this.charts.origem.destroy();
                    const data = this.statsPorOrigem;
                    this.charts.origem = new Chart(ctxOrigem, {
                        type: 'doughnut',
                        data: {
                            labels: data.map(d => d.nome),
                            datasets: [{ 
                                data: data.map(d => d.total), 
                                backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'],
                                borderWidth: 0
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
                    });
                }

                const ctxEtapas = document.getElementById('chartEtapas');
                if(ctxEtapas) {
                    if(this.charts.etapas) this.charts.etapas.destroy();
                    const data = this.etapas.map(e => leadsData.filter(l => l.etapa === e).length);
                    this.charts.etapas = new Chart(ctxEtapas, {
                        type: 'bar',
                        data: {
                            labels: this.etapas.map(e => e.split(' ')[0]),
                            datasets: [{ label: 'Leads', data: data, backgroundColor: '#6366F1', borderRadius: 6 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' }
                    });
                }
            },

            startDrag(evt, lead) {
                evt.dataTransfer.dropEffect = 'move';
                evt.dataTransfer.effectAllowed = 'move';
                evt.dataTransfer.setData('leadId', lead.id);
            },
            async onDrop(evt, novaEtapa) {
                const leadId = evt.dataTransfer.getData('leadId');
                const lead = this.leads.find(l => l.id === leadId);
                
                if (lead && novaEtapa === 'Negociação' && !lead.nome) {
                    alert("🚫 Preencha o NOME antes de negociar.");
                    return;
                }

                if(lead) {
                    lead.etapa = novaEtapa;
                    if(this.view === 'dashboard') this.updateCharts();
                }

                if (novaEtapa === 'Recebido (Fechado)') {
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                    if (!lead.dataFechamento) lead.dataFechamento = new Date().toISOString().split('T')[0];
                }

                if (this.dbConnected) {
                    const leadRef = doc(db, 'leads', leadId);
                    const updatePayload = { etapa: novaEtapa };
                    if(lead.dataFechamento) updatePayload.dataFechamento = lead.dataFechamento;
                    await updateDoc(leadRef, updatePayload);
                }
            },

            openModal() {
                this.form = { 
                    id: null, nome: '', telefone: '', beneficio: '', condicao: '',
                    cidade: '', estado: '', obs: '', consultor: '', fratura: '',
                    origem: 'Meta', campanha: '',
                    receitaEstimada: 0, receitaRealizada: 0,
                    etapa: 'Primeiro Contato', 
                    historicoMsg: [], 
                    msgAtiva: false,
                    dataFechamento: ''
                };
                this.novaMsgCoord = ''; this.novaMsgVendedor = '';
                this.editingLead = null;
                this.showModal = true;
                this.cidadesPorEstado = [];
            },
            editLead(lead) {
                this.form = { ...lead };
                if(this.form.estado) {
                    this.carregarCidades(this.form.estado);
                }
                
                if(!this.form.historicoMsg) this.form.historicoMsg = [];
                if(this.form.msgCoordenador && this.form.historicoMsg.length === 0) {
                     this.form.historicoMsg.push({ tipo: 'coord', texto: this.form.msgCoordenador, data: new Date().toISOString() });
                }
                this.novaMsgCoord = ''; this.novaMsgVendedor = '';
                this.editingLead = true;
                this.showModal = true;
            },
            async saveLead() {
                if (!this.dbConnected) return alert("Erro: Offline.");
                const data = { ...this.form };
                data.sala = this.salaAtual;
                delete data.id;

                const leadsRef = collection(db, 'leads');
                if (this.editingLead) {
                    await updateDoc(doc(db, 'leads', this.form.id), data);
                } else {
                    data.dataCriacao = new Date().toISOString();
                    await addDoc(leadsRef, data);
                }
                this.closeModal();
                this.showToast('Salvo com sucesso!');
            },
            async deleteLead() {
                await deleteDoc(doc(db, 'leads', this.form.id));
                this.showToast('Lead excluído permanentemente!', 'fa-trash');
                this.closeModal();
            },
            closeModal() { this.showModal = false; },
            addConsultor() {
                if(this.novoConsultor) {
                    this.listaConsultores.push(this.novoConsultor);
                    localStorage.setItem('revive_consultores', JSON.stringify(this.listaConsultores));
                    this.novoConsultor = '';
                }
            },
            removeConsultor(index) {
                this.listaConsultores.splice(index, 1);
                localStorage.setItem('revive_consultores', JSON.stringify(this.listaConsultores));
            },
            // NOVOS MÉTODOS MULTI-SESSION
            addNewSession() {
                if(!this.newSessionName || this.newSessionName.trim() === '') {
                    this.showToast('Digite um nome para adicionar!', 'fa-circle-exclamation');
                    return;
                }
                this.whatsappSessions.push({
                    nome: this.newSessionName.trim(),
                    id: Date.now()
                });
                localStorage.setItem('revive_whatsapp_sessions', JSON.stringify(this.whatsappSessions));
                this.newSessionName = '';
                this.showToast('Vendedor adicionado!', 'fa-user-plus');
            },
            removeSession(index) {
                this.whatsappSessions.splice(index, 1);
                localStorage.setItem('revive_whatsapp_sessions', JSON.stringify(this.whatsappSessions));
                if(this.activeSessionIndex === index) this.activeSessionIndex = null;
                this.showToast('Painel removido!', 'fa-trash');
            },
            openExternalWhatsapp() {
                window.open('https://web.whatsapp.com/', '_blank', 'width=1000,height=700');
            },

            // --- FUNÇÕES DE EXPORTAÇÃO ---
            getFilteredExportData() {
                let filtered = this.leads;
                
                // Filtro por Data (se selecionada)
                if(this.exportData.date) {
                    filtered = filtered.filter(l => (l.dataCriacao || '').slice(0,10) === this.exportData.date);
                }

                // Filtro por Consultor (se selecionado)
                if(this.exportData.consultor) {
                    filtered = filtered.filter(l => l.consultor === this.exportData.consultor);
                }

                return filtered;
            },
            generateCSV() {
                const data = this.getFilteredExportData();
                if(data.length === 0) return this.showToast('Nenhum dado para exportar na data selecionada.', 'fa-circle-exclamation');

                let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // BOM para acentos
                csvContent += "Nome,Telefone,Fratura,Observacao\n"; // Cabeçalho

                data.forEach(l => {
                    const nome = (l.nome || l.telefone || 'Sem Nome').replace(/,/g, ' '); // Evitar quebra do CSV
                    const fone = (l.telefone || '').replace(/,/g, ' ');
                    const fratura = (l.fratura || 'N/A').replace(/,/g, ' ');
                    const obs = (l.obs || '').replace(/(\r\n|\n|\r)/gm, " ").replace(/,/g, ';'); 
                    
                    csvContent += `${nome},${fone},${fratura},${obs}\n`;
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `Relatorio_Revive_${this.exportData.date}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                this.showToast('Planilha gerada!', 'fa-file-csv');
            },
            generateWord() {
                const data = this.getFilteredExportData();
                if(data.length === 0) return this.showToast('Nenhum dado para exportar.', 'fa-circle-exclamation');

                let htmlContent = `
                    <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                    <head><meta charset='utf-8'><title>Relatório Diário</title>
                    <style>
                        body { font-family: Arial, sans-serif; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #000; padding: 8px; text-align: left; vertical-align: top; }
                        th { background-color: #f2f2f2; }
                        h1 { color: #2563EB; }
                    </style>
                    </head><body>
                    <h1>Relatório Diário - Revive CRM</h1>
                    <p><strong>Data:</strong> ${this.exportData.date.split('-').reverse().join('/')}</p>
                    <p><strong>Total de Registros:</strong> ${data.length}</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Nome / Identificação</th>
                                <th>Telefone</th>
                                <th>Fratura</th>
                                <th>Observações</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.forEach(l => {
                     htmlContent += `
                        <tr>
                            <td>${l.nome || 'Sem Nome'}</td>
                            <td>${l.telefone || '-'}</td>
                            <td>${l.fratura || '-'}</td>
                            <td>${l.obs || ''}</td>
                        </tr>
                     `;
                });

                htmlContent += `</tbody></table></body></html>`;

                const blob = new Blob(['\ufeff', htmlContent], { type: 'application/msword' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `Resumo_Revive_${this.exportData.date}.doc`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                this.showToast('Documento Word gerado!', 'fa-file-word');
            }
        }
    }).mount('#app');
</script>
</body>
</html>
