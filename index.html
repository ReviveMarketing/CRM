<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Análise de Leads</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilo para a barra de rolagem */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #a8a8a8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .modal-backdrop, .confirm-backdrop {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); z-index: 40;
        }
        .modal, .confirm-modal {
            display: none; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); z-index: 50;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Container Principal do App -->
    <div id="appContainer">
        <!-- Cabeçalho Roxo -->
        <header class="bg-gradient-to-r from-purple-600 to-indigo-700 text-white shadow-lg">
            <div class="container mx-auto p-4 md:p-6 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">ReVive Leads Digitais</h1>
                    <p class="text-indigo-200">Painel de Análise de Desempenho</p>
                </div>
                <div class="text-right">
                    <div id="userInfo" class="hidden">
                        <p id="userName" class="font-semibold"></p>
                        <p id="userRole" class="text-sm text-indigo-200 capitalize"></p>
                        <button id="resetProfileBtn" class="text-xs text-yellow-300 hover:underline mt-1">Trocar de Perfil (Teste)</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Container Principal -->
        <main class="container mx-auto p-4 md:p-6">
             <div class="bg-white p-4 rounded-lg shadow-md mb-6 flex justify-between items-center">
                <div class="flex-grow grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-center">
                    <select id="consultantFilter" class="p-2 w-full border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="">Todos os Consultores</option>
                    </select>
                    <select id="statusFilter" class="p-2 w-full border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                         <option value="">Todas as Situações</option>
                         <option value="LETALK">LETALK</option>
                         <option value="LETALK - DUVIDA">LETALK - DUVIDA</option>
                         <option value="LETALK - NEGOCIAÇÃO">LETALK - NEGOCIAÇÃO</option>
                         <option value="AGUARDANDO RESPOSTA">AGUARDANDO RESPOSTA</option>
                         <option value="NEGOCIAÇÃO">NEGOCIAÇÃO</option>
                         <option value="NEGOCIAÇÃO CRIS">NEGOCIAÇÃO CRIS</option>
                         <option value="NEGOCIAÇÃO SEM RETORNO">NEGOCIAÇÃO SEM RETORNO</option>
                         <option value="FECHADO">FECHADO</option>
                         <option value="LETALK - FECHADO">LETALK - FECHADO</option>
                         <option value="SEM POSSIBILIDADE">SEM POSSIBILIDADE</option>
                         <option value="LETALK - SEM POSSIBILIDADE">LETALK - SEM POSSIBILIDADE</option>
                         <option value="LETALK - SEM RETORNO">LETALK - SEM RETORNO</option>
                         <option value="SEM DADOS">SEM DADOS</option>
                         <option value="DUVIDA">DUVIDA</option>
                    </select>
                    <div class="relative">
                        <label for="startDate" class="text-xs text-gray-500 absolute -top-2 left-2 bg-white px-1">De:</label>
                        <input type="date" id="startDate" class="p-2 w-full border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="relative">
                        <label for="endDate" class="text-xs text-gray-500 absolute -top-2 left-2 bg-white px-1">Até:</label>
                        <input type="date" id="endDate" class="p-2 w-full border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>
                <button id="addLeadBtn" class="ml-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold p-2 rounded-full shadow-md transition duration-300 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                </button>
            </div>


            <!-- Dashboard de Métricas -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6 mb-6">
                <!-- Cards de métricas aqui... -->
                 <div class="bg-white p-6 rounded-lg shadow-md flex flex-col justify-between"><h3 class="text-gray-500 font-medium">Total de Leads</h3><p id="metricTotalLeads" class="text-4xl font-bold text-blue-600">0</p></div>
                 <div class="bg-white p-6 rounded-lg shadow-md flex flex-col justify-between"><h3 class="text-gray-500 font-medium">Em Negociação</h3><p id="metricEmNegociacao" class="text-4xl font-bold text-yellow-500">0</p></div>
                 <div class="bg-white p-6 rounded-lg shadow-md flex flex-col justify-between"><h3 class="text-gray-500 font-medium">Leads Convertidos</h3><p id="metricConvertidos" class="text-4xl font-bold text-green-600">0</p></div>
                 <div class="bg-white p-6 rounded-lg shadow-md flex flex-col justify-between"><h3 class="text-gray-500 font-medium">Leads Perdidos</h3><p id="metricPerdidos" class="text-4xl font-bold text-red-600">0</p></div>
                 <div class="bg-white p-6 rounded-lg shadow-md flex flex-col justify-between"><h3 class="text-gray-500 font-medium">Taxa de Conversão</h3><p id="metricTaxaConversao" class="text-4xl font-bold text-green-600">0%</p></div>
                 <div class="bg-white p-6 rounded-lg shadow-md flex flex-col justify-between"><h3 class="text-gray-500 font-medium">Ciclo de Vendas (dias)</h3><p id="metricCicloVendas" class="text-4xl font-bold text-purple-600">0</p></div>
            </div>

            <!-- Barra de busca e Exportação -->
            <div class="bg-white p-4 rounded-lg shadow-sm mb-6 flex flex-col md:flex-row gap-4">
                <input type="text" id="searchInput" placeholder="Buscar por observação, contato..." class="flex-grow p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <button id="exportCsvBtn" class="w-full md:w-auto bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-700 transition duration-300 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    Exportar CSV
                </button>
            </div>

            <!-- Tabela de Leads -->
            <div class="bg-white rounded-lg shadow-md overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data/Hora</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Consultor</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contato</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Situação</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Observações</th>
                            <th scope="col" class="relative px-6 py-3"><span class="sr-only">Ações</span></th>
                        </tr>
                    </thead>
                    <tbody id="leadsTableBody" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="6" class="text-center p-8 text-gray-500">Carregando dados...</td></tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>
    
    <!-- Modal de Configuração Inicial (Primeiro Acesso) -->
    <div id="setupModalBackdrop" class="modal-backdrop"></div>
    <div id="setupModal" class="modal w-11/12 max-w-md bg-white rounded-lg shadow-xl">
        <form id="setupForm" class="p-8">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-2">Bem-vindo ao CRM!</h2>
            <p class="text-center text-gray-500 mb-6">Vamos configurar seu perfil.</p>
            <div class="mb-4">
                <label for="setupName" class="block text-sm font-medium text-gray-700 mb-1">Seu Nome</label>
                <input type="text" id="setupName" required placeholder="Ex: João Silva" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
             <div class="mb-4">
                <label for="setupCode" class="block text-sm font-medium text-gray-700 mb-1">Código de Acesso (para Gerentes)</label>
                <input type="text" id="setupCode" placeholder="Opcional" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <div class="mb-6">
                 <label for="setupRole" class="block text-sm font-medium text-gray-700 mb-1">Qual é a sua função?</label>
                 <select id="setupRole" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                     <option value="consultor">Consultor</option>
                     <option value="gerente" disabled>Gerente</option>
                 </select>
            </div>
            <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-300">Salvar e Começar</button>
        </form>
    </div>

    <!-- Modais (Add/Edit, Confirm) aqui... -->
    <div id="modalBackdrop" class="modal-backdrop"></div><div id="leadModal" class="modal w-11/12 max-w-2xl bg-white rounded-lg shadow-xl"><form id="leadForm" class="p-6"><h2 id="modalTitle" class="text-2xl font-bold mb-4">Adicionar Novo Lead</h2><input type="hidden" id="leadId"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="consultor" class="block text-sm font-medium text-gray-700">Consultor</label><input type="text" id="consultor" name="consultor" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></div><div><label for="contato" class="block text-sm font-medium text-gray-700">Contato (Telefone)</label><input type="tel" id="contato" name="contato" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></div><div><label for="indicacao" class="block text-sm font-medium text-gray-700">Indicação / Origem</label><input type="text" id="indicacao" name="indicacao" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div><div><label for="situacao" class="block text-sm font-medium text-gray-700">Situação</label><select id="situacao" name="situacao" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required><option value="LETALK">LETALK</option><option value="LETALK - DUVIDA">LETALK - DUVIDA</option><option value="LETALK - NEGOCIAÇÃO">LETALK - NEGOCIAÇÃO</option><option value="AGUARDANDO RESPOSTA">AGUARDANDO RESPOSTA</option><option value="NEGOCIAÇÃO">NEGOCIAÇÃO</option><option value="NEGOCIAÇÃO CRIS">NEGOCIAÇÃO CRIS</option><option value="NEGOCIAÇÃO SEM RETORNO">NEGOCIAÇÃO SEM RETORNO</option><option value="FECHADO">FECHADO</option><option value="LETALK - FECHADO">LETALK - FECHADO</option><option value="SEM POSSIBILIDADE">SEM POSSIBILIDADE</option><option value="LETALK - SEM POSSIBILidade">LETALK - SEM POSSIBILIDADE</option><option value="LETALK - SEM RETORNO">LETALK - SEM RETORNO</option><option value="SEM DADOS">SEM DADOS</option><option value="DUVIDA">DUVIDA</option></select></div><div class="md:col-span-2"><label for="observacao" class="block text-sm font-medium text-gray-700">Observação</label><textarea id="observacao" name="observacao" rows="4" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></textarea></div><div class="md:col-span-2"><label for="dataFechamento" class="block text-sm font-medium text-gray-700">Data de Fechamento</label><input type="date" id="dataFechamento" name="dataFechamento" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div></div><div class="mt-6 flex justify-end gap-3"><button type="button" id="cancelBtn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300">Cancelar</button><button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">Salvar</button></div></form></div>
    <div id="confirmBackdrop" class="confirm-backdrop"></div><div id="confirmModal" class="confirm-modal w-11/12 max-w-sm bg-white rounded-lg shadow-xl p-6"><h3 id="confirmTitle" class="text-lg font-bold text-gray-800 mb-4">Confirmar Ação</h3><p id="confirmMessage" class="text-gray-600 mb-6">Tem certeza que deseja continuar?</p><div class="flex justify-end gap-3"><button id="confirmCancelBtn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300">Cancelar</button><button id="confirmOkBtn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-700 transition duration-300">Confirmar</button></div></div>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, serverTimestamp, query, where, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAÇÃO E INICIALIZAÇÃO ---
        
        // Suas credenciais do Firebase.
        const firebaseConfig = {
            apiKey: "AIzaSyBj2MZ6E_wlJ3rKRhD3AMJx0JGloLOK4dc",
            authDomain: "crm---vendas.firebaseapp.com",
            projectId: "crm---vendas",
            storageBucket: "crm---vendas.firebasestorage.app",
            messagingSenderId: "457769771696",
            appId: "1:457769771696:web:3cbc7647f82a9a2fca9175",
            measurementId: "G-BLM746XMMB"
        };
        
        // Lembre-se de habilitar a autenticação "Anônima" e criar o banco de dados Firestore no seu painel do Firebase.
        const MANAGER_SECRET_CODE = "GERENTE2025"; 
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null; // { uid, name, email, role }
        let unsubscribeLeads = null;
        let localLeads = [];
        
        // --- LÓGICA DE AUTENTICAÇÃO E SETUP INICIAL ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userRef = doc(db, 'users', user.uid);
                try {
                    const userDoc = await getDoc(userRef);

                    if (userDoc.exists()) {
                        currentUser = { uid: user.uid, email: user.email, ...userDoc.data() };
                        hideSetupModal();
                        initializeAppUI();
                        setupFirestoreListeners();
                    } else {
                        showSetupModal(user);
                    }
                } catch (error) {
                    console.error("Erro ao carregar perfil do usuário:", error);
                    let errorMessage = `
                        <div class="p-4 text-center">
                            <h3 class="font-bold text-lg">Não foi possível conectar ao banco de dados.</h3>
                            <p class="mt-2">Por favor, verifique os seguintes pontos:</p>
                            <ul class="list-disc list-inside text-left inline-block mt-2">
                                <li>Você já clicou em "Criar banco de dados" no painel do Firestore?</li>
                                <li>As <a href="https://console.firebase.google.com/project/${firebaseConfig.projectId}/firestore/rules" target="_blank" class="text-blue-600 underline">regras de segurança</a> do Firestore foram publicadas?</li>
                                <li>Sua conexão com a internet está ativa?</li>
                            </ul>
                        </div>
                    `;
                    document.getElementById('leadsTableBody').innerHTML = `<tr><td colspan="6" class="p-8 text-red-500">${errorMessage}</td></tr>`;
                }
            } else {
                 try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Authentication failed:", error);
                    document.getElementById('leadsTableBody').innerHTML = '<tr><td colspan="6" class="text-center p-8 text-red-500">Falha na autenticação. Verifique as configurações do seu projeto Firebase.</td></tr>';
                }
            }
        });
        
        function initializeAppUI() {
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = currentUser.role;
        }

        // --- MODAL DE SETUP ---
        const setupModal = document.getElementById('setupModal');
        const setupModalBackdrop = document.getElementById('setupModalBackdrop');
        const setupForm = document.getElementById('setupForm');
        const setupCodeInput = document.getElementById('setupCode');
        const setupRoleSelect = document.getElementById('setupRole');

        function showSetupModal(user) {
            setupModal.style.display = 'block';
            setupModalBackdrop.style.display = 'block';
            
            setupCodeInput.addEventListener('input', () => {
                const managerOption = setupRoleSelect.querySelector('option[value="gerente"]');
                if (setupCodeInput.value.trim() === MANAGER_SECRET_CODE) {
                    managerOption.disabled = false;
                } else {
                    managerOption.disabled = true;
                    setupRoleSelect.value = 'consultor';
                }
            });

            setupForm.onsubmit = async (e) => {
                e.preventDefault();
                const submitButton = e.target.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.textContent = "Salvando...";

                const name = setupForm.setupName.value;
                const role = setupForm.setupRole.value;
                if(name.trim()){
                    const userRef = doc(db, 'users', user.uid);
                    const profileData = { name, role, email: user.email };

                    try {
                        await setDoc(userRef, profileData);
                        
                        currentUser = { uid: user.uid, email: user.email, ...profileData };
                        initializeAppUI();
                        setupFirestoreListeners();
                        hideSetupModal();
                    } catch (error) {
                         console.error("Erro ao salvar o perfil:", error);
                         submitButton.disabled = false;
                         submitButton.textContent = "Salvar e Começar";
                    }
                } else {
                    submitButton.disabled = false;
                    submitButton.textContent = "Salvar e Começar";
                }
            };
        }
        function hideSetupModal() {
            setupModal.style.display = 'none';
            setupModalBackdrop.style.display = 'none';
        }


        // --- LÓGICA DO FIRESTORE ---
        function setupFirestoreListeners() {
            if (!currentUser) return;
            const leadsCollectionRef = collection(db, 'leads');
            
            let q;
            if (currentUser.role === 'gerente') {
                q = query(leadsCollectionRef);
                document.getElementById('consultantFilter').style.display = 'block';
            } else { // Consultor
                q = query(leadsCollectionRef, where('consultorId', '==', currentUser.uid));
                document.getElementById('consultantFilter').style.display = 'none';
            }

            if (unsubscribeLeads) unsubscribeLeads(); 

            unsubscribeLeads = onSnapshot(q, (snapshot) => {
                localLeads = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                localLeads.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                
                if (currentUser.role === 'gerente') {
                    populateConsultantFilter();
                }
                applyFiltersAndRender();
            }, (error) => console.error("Error fetching leads:", error));
        }

        // --- FILTROS E RENDERIZAÇÃO ---
        function applyFiltersAndRender() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const consultantFilter = document.getElementById('consultantFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            const filteredLeads = localLeads.filter(lead => {
                const matchesSearch = (lead.observacao?.toLowerCase() || '').includes(searchInput) ||
                                      (lead.contato?.toLowerCase() || '').includes(searchInput) ||
                                      (lead.consultor?.toLowerCase() || '').includes(searchInput);
                const matchesStatus = !statusFilter || lead.situacao === statusFilter;
                const matchesConsultant = currentUser.role === 'gerente' ? (!consultantFilter || lead.consultorId === consultantFilter) : true;
                
                const leadDate = lead.createdAt ? lead.createdAt.toDate() : null;
                const matchesDate = (!startDate || !leadDate || leadDate >= new Date(startDate)) &&
                                    (!endDate || !leadDate || leadDate <= new Date(endDate + 'T23:59:59'));
                
                return matchesSearch && matchesStatus && matchesConsultant && matchesDate;
            });

            renderDashboard(filteredLeads);
            renderTable(filteredLeads);
        }

        function populateConsultantFilter() {
            const consultantFilter = document.getElementById('consultantFilter');
            const consultantsMap = new Map(localLeads.map(lead => [lead.consultorId, lead.consultor]).filter(([id, name]) => id && name));
            const currentSelection = consultantFilter.value;
            
            while (consultantFilter.options.length > 1) { consultantFilter.remove(1); }
            
            [...consultantsMap.entries()].sort((a, b) => a[1].localeCompare(b[1])).forEach(([id, name]) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = name;
                consultantFilter.appendChild(option);
            });
            consultantFilter.value = currentSelection;
        }
        
        function renderDashboard(leads){
             const totalLeads=leads.length;const negociacaoStatus=['NEGOCIAÇÃO','LETALK - NEGOCIAÇÃO','AGUARDANDO RESPOSTA','NEGOCIAÇÃO CRIS','NEGOCIAÇÃO SEM RETORNO'];const emNegociacao=leads.filter(l=>negociacaoStatus.includes(l.situacao)).length;const convertidosStatus=['FECHADO','LETALK - FECHADO'];const convertidos=leads.filter(l=>convertidosStatus.includes(l.situacao));const totalConvertidos=convertidos.length;const perdidosStatus=['SEM POSSIBILIDADE','LETALK - SEM POSSIBILIDADE'];const totalPerdidos=leads.filter(l=>perdidosStatus.includes(l.situacao)).length;const taxaConversao=totalLeads>0?((totalConvertidos/totalLeads)*100).toFixed(1):0;let cicloVendas=0;if(totalConvertidos>0){const duracoes=convertidos.map(l=>{if(l.createdAt&&l.dataFechamento){const inicio=l.createdAt.toDate();const fim=new Date(l.dataFechamento);const diffTime=Math.abs(fim-inicio);return Math.ceil(diffTime/(1000*60*60*24))}return null}).filter(d=>d!==null);if(duracoes.length>0){const somaDuracoes=duracoes.reduce((acc,curr)=>acc+curr,0);cicloVendas=(somaDuracoes/duracoes.length).toFixed(1)}}
             document.getElementById('metricTotalLeads').textContent=totalLeads;document.getElementById('metricEmNegociacao').textContent=emNegociacao;document.getElementById('metricConvertidos').textContent=totalConvertidos;document.getElementById('metricPerdidos').textContent=totalPerdidos;document.getElementById('metricTaxaConversao').textContent=`${taxaConversao}%`;document.getElementById('metricCicloVendas').textContent=cicloVendas;
        }
        function renderTable(leads){const tableBody=document.getElementById('leadsTableBody');if(leads.length===0){tableBody.innerHTML='<tr><td colspan="6" class="text-center p-8 text-gray-500">Nenhum lead encontrado.</td></tr>';return}tableBody.innerHTML=leads.map(lead=>`
            <tr class="hover:bg-gray-50"><td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">${lead.createdAt?new Date(lead.createdAt.toDate()).toLocaleDateString('pt-BR'):'N/A'}</div><div class="text-sm text-gray-500">${lead.createdAt?new Date(lead.createdAt.toDate()).toLocaleTimeString('pt-BR'):''}</div></td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${lead.consultor||''}</td><td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">${lead.contato||''}</div><div class="text-sm text-gray-500">${lead.indicacao||''}</div></td><td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusBadge(lead.situacao)}">${lead.situacao||''}</span></td><td class="px-6 py-4 text-sm text-gray-600 max-w-xs truncate" title="${lead.observacao||''}">${lead.observacao||''}</td><td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            ${(currentUser.role==='gerente'||currentUser.uid===lead.consultorId)?`<button class="text-indigo-600 hover:text-indigo-900 edit-btn" data-id="${lead.id}">Editar</button><button class="text-red-600 hover:text-red-900 ml-4 delete-btn" data-id="${lead.id}">Excluir</button>`:''}</td></tr>`).join('');addTableActionListeners()}
        function getStatusBadge(status){switch(status){case'SEM POSSIBILIDADE':case'LETALK - SEM POSSIBILIDADE':return'bg-red-200 text-red-800';case'LETALK':return'bg-yellow-200 text-yellow-800';case'FECHADO':case'LETALK - FECHADO':return'bg-green-200 text-green-800';case'NEGOCIAÇÃO':case'NEGOCIAÇÃO CRIS':case'LETALK - NEGOCIAÇÃO':return'bg-pink-200 text-pink-800';case'AGUARDANDO RESPOSTA':return'bg-gray-400 text-white';case'SEM DADOS':return'bg-gray-300 text-gray-700';case'DUVIDA':case'LETALK - DUVIDA':return'bg-blue-200 text-blue-800';case'NEGOCIAÇÃO SEM RETORNO':case'LETALK - SEM RETORNO':return'bg-cyan-200 text-cyan-800';default:return'bg-gray-200 text-gray-800'}}
        
        const modal = document.getElementById('leadModal');
        const modalBackdrop = document.getElementById('modalBackdrop');
        const addLeadBtn = document.getElementById('addLeadBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const leadForm = document.getElementById('leadForm');
        
        function openModal() { modal.style.display = 'block'; modalBackdrop.style.display = 'block'; }
        function closeModal() { modal.style.display = 'none'; modalBackdrop.style.display = 'none'; leadForm.reset(); document.getElementById('leadId').value = ''; }

        addLeadBtn.addEventListener('click', () => {
             document.getElementById('modalTitle').textContent = 'Adicionar Novo Lead';
             const consultorInput = leadForm.consultor;
             consultorInput.value = currentUser.name;
             if (currentUser.role === 'consultor') {
                 consultorInput.readOnly = true;
                 consultorInput.classList.add('bg-gray-100');
             } else {
                 consultorInput.readOnly = false;
                 consultorInput.classList.remove('bg-gray-100');
             }
             openModal();
        });
        cancelBtn.addEventListener('click', closeModal);
        modalBackdrop.addEventListener('click', closeModal);

        const confirmModal = document.getElementById('confirmModal');
        const confirmBackdrop = document.getElementById('confirmBackdrop');
        let resolveConfirm = null;
        function showConfirm(title, message){document.getElementById('confirmTitle').textContent=title;document.getElementById('confirmMessage').textContent=message;confirmModal.style.display='block';confirmBackdrop.style.display='block';return new Promise((resolve)=>{resolveConfirm=resolve})}function hideConfirm(){confirmModal.style.display='none';confirmBackdrop.style.display='none'}
        document.getElementById('confirmOkBtn').addEventListener('click',()=>{if(resolveConfirm)resolveConfirm(true);hideConfirm()});document.getElementById('confirmCancelBtn').addEventListener('click',()=>{if(resolveConfirm)resolveConfirm(false);hideConfirm()});confirmBackdrop.addEventListener('click',()=>{if(resolveConfirm)resolveConfirm(false);hideConfirm()});

        leadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const leadId = document.getElementById('leadId').value;
            const leadData = {
                consultor: leadForm.consultor.value.trim(),
                contato: leadForm.contato.value.trim(),
                indicacao: leadForm.indicacao.value.trim(),
                situacao: leadForm.situacao.value,
                observacao: leadForm.observacao.value.trim(),
                dataFechamento: leadForm.dataFechamento.value || null,
                updatedAt: serverTimestamp()
            };

            try {
                if (leadId) {
                    const leadRef = doc(db, 'leads', leadId);
                    await updateDoc(leadRef, leadData);
                } else {
                    leadData.createdAt = serverTimestamp();
                    leadData.consultorId = currentUser.uid;
                    await addDoc(collection(db, 'leads'), leadData);
                }
                closeModal();
            } catch (error) { console.error("Erro ao salvar lead: ", error); }
        });
        
        document.getElementById('resetProfileBtn').addEventListener('click', async () => {
            const confirmed = await showConfirm('Trocar de Perfil', 'Isso irá apagar seu perfil atual (Gerente ou Consultor) para que você possa se registrar novamente. Deseja continuar?');
            if (confirmed && currentUser) {
                try {
                    const userRef = doc(db, 'users', currentUser.uid);
                    await deleteDoc(userRef);
                    location.reload();
                } catch (error) {
                    console.error("Erro ao resetar o perfil:", error);
                }
            }
        });

        function addTableActionListeners() {
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    const lead = localLeads.find(l => l.id === id);
                    if (lead) {
                        document.getElementById('modalTitle').textContent = 'Editar Lead';
                        document.getElementById('leadId').value = lead.id;
                        leadForm.consultor.value = lead.consultor || '';
                        leadForm.contato.value = lead.contato || '';
                        leadForm.indicacao.value = lead.indicacao || '';
                        leadForm.situacao.value = lead.situacao || 'Novo';
                        leadForm.observacao.value = lead.observacao || '';
                        leadForm.dataFechamento.value = lead.dataFechamento || '';
                        
                        const consultorInput = leadForm.consultor;
                        if(currentUser.role === 'consultor') {
                            consultorInput.readOnly = true;
                            consultorInput.classList.add('bg-gray-100');
                        } else {
                             consultorInput.readOnly = false;
                             consultorInput.classList.remove('bg-gray-100');
                        }
                        openModal();
                    }
                });
            });

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const id = e.target.dataset.id;
                    const confirmed = await showConfirm('Excluir Lead', 'Tem certeza que deseja excluir este lead?');
                    if (confirmed) {
                        try {
                            await deleteDoc(doc(db, 'leads', id));
                        } catch (error) { console.error("Erro ao excluir lead: ", error); }
                    }
                });
            });
        }
        
        ['searchInput', 'statusFilter', 'consultantFilter', 'startDate', 'endDate'].forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.addEventListener('input', applyFiltersAndRender);
                el.addEventListener('change', applyFiltersAndRender);
            }
        });
        
        function escapeCsvCell(cell){if(cell==null)return'';const strCell=String(cell);if(strCell.includes(',')||strCell.includes('"')||strCell.includes('\n')){return`"${strCell.replace(/"/g,'""')}"`}return strCell}
        function exportToCsv(){const leadsToExport=localLeads;if(leadsToExport.length===0){showConfirm('Exportar CSV','Não há leads para exportar.').then(r=>{});return}const headers=['Data Criacao','Hora Criacao','Consultor','Contato','Indicacao','Situacao','Observacao','Data Fechamento'];const rows=leadsToExport.map(lead=>{const createdAt=lead.createdAt?lead.createdAt.toDate():null;return[createdAt?createdAt.toLocaleDateString('pt-BR'):'',createdAt?createdAt.toLocaleTimeString('pt-BR'):'',escapeCsvCell(lead.consultor),escapeCsvCell(lead.contato),escapeCsvCell(lead.indicacao),escapeCsvCell(lead.situacao),escapeCsvCell(lead.observacao),lead.dataFechamento||''].join(',')});const csvContent="data:text/csv;charset=utf-8,"+headers.join(',')+'\n'+rows.join('\n');const encodedUri=encodeURI(csvContent);const link=document.createElement("a");link.setAttribute("href",encodedUri);link.setAttribute("download",`crm_leads_${new Date().toISOString().slice(0,10)}.csv`);document.body.appendChild(link);link.click();document.body.removeChild(link)}
        document.getElementById('exportCsvBtn').addEventListener('click', exportToCsv);

    </script>
</body>
</html>

